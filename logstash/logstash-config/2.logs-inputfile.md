# logstash get log from nginx logs file va push toi logstash file

# install and config nginx

# /etc/nginx/nginx.conf

        log_format custom_log  '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" '
                       '"$http_user_agent" "$http_x_forwarded_for"'
                       '"$http_authority"' \t\n
                       '"$http_authorization"' ;

# /etc/nginx/sites-enabled/vietdung.com

server {
    listen 80;
    root /var/www/vietdung/html;
    index index.html;
    server_name vietdung.com www.vietdung.com haha.com;
    access_log /home/vagrant/access.log  custom_log;
    location / {
        try_files $uri $uri/ =404;
    }
}

# logs at path /home/vagrant/access.log

# dùng logstash để get logs từ folder logs 

input {
  file {
    path => "/home/vagrant/access.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

output {
    stdout {
        codec => rubydebug
    }
  
    file {
        path => "output.txt"
    }
}

./bin/logstash -f logstash-input-opensearch.conf --config.reload.automatic 


# set type


input {
    stdin {
        codec => json
    }
    http {
        host => "0.0.0.0"
        port => 8080
        type => vietdung
    }
}

filter {
  grok {
    match => { "message" => "%{COMBINEDAPACHELOG}" }
  }
  date {
    match => [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
  }
  mutate {
    remove_field => [ "[headers][accept_encoding]" ]
  }
}


output {
    stdout {
        codec => rubydebug
    }

    if [type] == "vietdung" {
      file {
          path => "access.txt"
        }
      }
    else {
      file {
          path => "error.txt"
      }
    }
}

# remove field

  mutate {
    remove_field => [ "[headers][accept_encoding]" ]
  }


