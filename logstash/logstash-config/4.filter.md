
#  nhiều dòng thành 1 dòng  : nhung dang nay dinh nghia voi data co timestamp kieu IS 

input {
   beats {
     port => 5044
   }
 }
filter {
  multiline {
    pattern => "^\[%{TIMESTAMP_ISO8601}\]"
    negate => true
    what => "previous"
  }
  mutate {
    remove_field => [ "[agent]", "[@version]", "ecs", "host" ]
  }
}

output {
  elasticsearch {
    hosts => "http://192.168.59.10:9200"
    index => "%{[kubernetes][namespace]}"
    user => "elastic"
    password => "vietdungvl"    
 }
}


#  time khac
input {
   beats {
     port => 5044
   }
 }
filter {
  multiline {
    pattern => "^\w{3} \d{1,2}, \d{4} @ \d{2}:\d{2}:\d{2}"
    negate => true
    what => "previous"
  }

  mutate {
    remove_field => [ "[agent]", "[@version]", "ecs", "host" ]
  }
}

output {
  elasticsearch {
    hosts => "http://192.168.59.10:9200"
    index => "%{[kubernetes][namespace]}"
    user => "elastic"
    password => "vietdungvl"    
 }
}



# ####################  mutate ################
"mutate" cho phép bạn thêm, sửa đổi hoặc xóa các trường (fields) trong sự kiện hoặc thay đổi giá trị của các trường hiện có.
#  add_field : them truong
# remove_field:  bo truong

filter {
  mutate {
    add_field => { "is_admin" => "false" }
  }
  if "admin_user" in [username] {
    mutate {
      replace => { "is_admin" => "true" }
    }
  }
}

Trong ví dụ trên, chúng ta đã sử dụng filter "mutate" để thêm trường "is_admin" với giá trị mặc định là "false". Sau đó, nếu trường "username" chứa chuỗi "admin_user", chúng ta sẽ thực hiện một thay đổi dùng "replace" để ghi đè giá trị "is_admin" thành "true".


# #################### grok ####################
Trong Logstash, "grok" là một filter plugin mạnh mẽ được sử dụng để phân tích cú pháp (parsing) dữ liệu không có cấu trúc thành các trường cụ thể có ý nghĩa. Thông thường, dữ liệu đầu vào của Logstash đến từ các logs hoặc dữ liệu không có cấu trúc khác và "grok" cho phép bạn tách những phần dữ liệu này thành các trường có thể truy vấn, hiển thị và phân tích dễ dàng.

Grok sử dụng các biểu thức chính quy (regular expressions) đặc biệt để so khớp và trích xuất thông tin từ dòng log hay chuỗi dữ liệu. Để sử dụng filter "grok" trong Logstash, bạn cần chỉ định mẫu (pattern) mà nó sẽ sử dụng để tách phần dữ liệu.

VD message
2023-07-29 12:34:56 INFO: User 'john_doe' logged in from IP 192.168.0.100

Bạn muốn phân tích cú pháp dòng log trên và tạo các trường như "timestamp", "log_level", "user", và "source_ip". Bạn có thể sử dụng "grok" như sau:

filter {
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:log_level}: User '%{USERNAME:user}' logged in from IP %{IP:source_ip}" }
  }
}
# Sau khi áp dụng filter "grok", sự kiện sẽ có dạng:
{
  "timestamp": "2023-07-29 12:34:56",
  "log_level": "INFO",
  "user": "john_doe",
  "source_ip": "192.168.0.100",
  "message": "2023-07-29 12:34:56 INFO: User 'john_doe' logged in from IP 192.168.0.100"
}

192.168.59.10 - jeo [20/Sep/2017:13:22:22 +0200] GET /product/view/123 200
%{IP:ip_address} %{USER:identity} %{USER:auth} \[%{HTTPDATE:req_ts}\] 

IP :  192.168.59.10
USER: joe
HTTPDATE : [20/Sep/2017:13:22:22 +0200]
URIPATHPARAM: /product/view/123
INT: 200
LOGLEVEL 

# thuc hanh
put message postman 
192.168.59.10 - jeo [20/Sep/2017:13:22:22 +0200]


filter {
  grok {
    match => { "message" => "%{IP:ip_address} %{USER:identity} %{USER:auth} \[%{HTTPDATE:req_ts}\]" }
  }
}

=> ta co them truong [ip_address , identity , req_ts ]

2. message
192.168.59.10 - jeo [20/Sep/2017:13:22:22 +0200] GET /product/view/123 200

%{IP:ip_address} %{USER:identity} %{USER:auth} \[%{HTTPDATE:req_ts}\] %{WORD:http_verb} %{URIPATHPARAM:req_path} %{INT:http_status:int}

filter {
  grok {
    match => { "message" => "%{IP:ip_address} %{USER:identity} %{USER:auth} \[%{HTTPDATE:req_ts}\] %{WORD:http_verb} %{URIPATHPARAM:req_path} %{INT:http_status:int}" }
  }
}


(?<msg>.+?(?=\n))